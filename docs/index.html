<h1 id="nz-util">nz-util</h1>
<blockquote>
<p>Netezza utility procedures</p>
</blockquote>
<p><strong>Version 2013-12-12</strong></p>
<h1 id="installation">Installation</h1>
<h2 id="download-the-code">Download the code</h2>
<p>If you are on a Linux box (for example the Netezza frontend itself), you can try with this command</p>
<pre><code class="lang-bash">wget --no-check-certificate --timestamping https://raw.github.com/fibo/nz-util/master/nz_util.sql</code></pre>
<p>If it does not work, just point your browser to</p>
<pre><code>https://raw.github.com/fibo/nz-util/master/nz_util.sql</code></pre>
<p>and use copy and paste, dude!</p>
<h2 id="install">Install</h2>
<pre><code class="lang-bash">nzsql -u admin -d system -c &#39;CREATE DATABASE util COLLECT HISTORY OFF&#39;
nzsql -u admin -d util -f nz_util.sql 1&gt; /dev/null</code></pre>
<h2 id="update">Update</h2>
<p>Check current version</p>
<pre><code class="lang-bash">nzsql -u admin -d util -c &#39;\dd util&#39;</code></pre>
<p>Update <em>Netezza utilities</em></p>
<pre><code class="lang-bash">nzsql -u admin -d util -f nz_util.sql 1&gt; /dev/null</code></pre>
<h1 id="utilities">Utilities</h1>
<h2 id="type-checking">Type checking</h2>
<hr>
<h3 id="is_table">is_table</h3>
<p>Returns true if given object is a <em>TABLE</em>, otherwise false.</p>
<pre><code class="lang-sql">CALL util..is_table(&#39;OBJECT_NAME&#39;);</code></pre>
<h3 id="is_view">is_view</h3>
<p>Returns true if given object is a <em>VIEW</em>, otherwise false.</p>
<pre><code class="lang-sql">CALL util..is_view(&#39;OBJECT_NAME&#39;);</code></pre>
<h3 id="is_sequence">is_sequence</h3>
<p>Returns true if given object is a <em>SEQUENCE</em>, otherwise false.</p>
<pre><code class="lang-sql">CALL util..is_sequence(&#39;OBJECT_NAME&#39;);</code></pre>
<h3 id="is_group">is_group</h3>
<p>Returns true if given object is a <em>GROUP</em>, otherwise false.</p>
<pre><code class="lang-sql">CALL util..is_group(&#39;OBJECT_NAME&#39;);</code></pre>
<h3 id="is_user">is_user</h3>
<p>Returns true if given object is a <em>USER</em>, otherwise false.</p>
<pre><code class="lang-sql">CALL util..is_user(&#39;OBJECT_NAME&#39;);</code></pre>
<h2 id="misc-utilities">Misc utilities</h2>
<h3 id="drop_table">drop_table</h3>
<p>Drop a <em>table</em> safely. If <em>table</em> does not exists, it will manage it to avoid
displaying an error message, so your logs will be cleaner.</p>
<p>Note that if some object (for example a procedure) depends on the given <em>table</em>
an error will occur.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..drop_table(&#39;TABLE_NAME&#39;);</code></pre>
<ul>
<li>avoids dropping tables in reserved catalogs</li>
<li><em>table</em> is dropped only if it exists</li>
</ul>
<h2 id="groups-and-grants-management">Groups and grants management</h2>
<h3 id="create_or_update_group">create_or_update_group</h3>
<p>Create a group safely. If group already exists, it will be granted to list current catalog.
Please note that since Netezza grants permissions contextually to current catalog,
you need to connect manually to catalog.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..create_or_update_group(&#39;GROUP_NAME&#39;);</code></pre>
<ul>
<li>avoids creating groups in reserved catalogs</li>
<li>if group already exists it just grants <em>list</em> on catalog</li>
<li>creates group if it does not exists and grants <em>list</em> on catalog</li>
</ul>
<h3 id="grant_readonly">grant_readonly</h3>
<p>Grant a group to read data in current catalog.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..grant_readonly(&#39;GROUP_NAME&#39;);</code></pre>
<ul>
<li>creates group if it does not exists</li>
<li>calls <a href="#grant_systemview">grant_systemview</a></li>
<li>grants <em>list, select</em> object privileges on <em>table, view, sequence</em></li>
</ul>
<h3 id="grant_external">grant_external</h3>
<p>Grant a group to create, read and write external tables in current catalog.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..grant_external(&#39;GROUP_NAME&#39;);</code></pre>
<ul>
<li>creates group if it does not exists</li>
<li>grants <em>list, select, drop</em> object privileges on <em>external table</em></li>
<li>grants <em>create external table</em> admin privilege</li>
</ul>
<h3 id="grant_systemview">grant_systemview</h3>
<p>Grant a group to read system views in current catalog.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..grant_systemview(&#39;GROUP_NAME&#39;);</code></pre>
<ul>
<li>creates group if it does not exists</li>
<li>grants <em>list, select</em> object privileges on <em>system view</em></li>
</ul>
<h3 id="grant_readwrite">grant_readwrite</h3>
<p>Grant a group to read and write data in current catalog.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..grant_readwrite(&#39;GROUP_NAME&#39;);</code></pre>
<ul>
<li>creates group if it does not exists</li>
<li>calls <a href="#grant_readonly">grant_readonly</a></li>
<li>calls <a href="#grant_external">grant_external</a></li>
<li>grants <em>insert, update, delete, truncate, alter, drop, genstats, groom</em> object privileges on <em>table</em></li>
<li>grants <em>list, select</em> object privileges on <em>sequence</em></li>
<li>grants <em>create table, create view, create sequence</em> admin privilege</li>
</ul>
<h3 id="grant_execute">grant_execute</h3>
<p>Grant a group to edit and call stored procedures and functions in current catalog.</p>
<pre><code class="lang-sql">\c mydatabase
CALL util..grant_execute(&#39;GROUP_NAME&#39;);</code></pre>
<ul>
<li>creates group if it does not exists</li>
<li>grants <em>list, select, update, drop, execute</em> object privileges on <em>function, procedure</em></li>
<li>grants <em>create function, create procedure</em> admin privilege</li>
</ul>
<h3 id="objects_owned_by">objects_owned_by</h3>
<p>When you want to delete a user you need to know which objects he owns.
See <a href="http://blog.g14n.info/2013/12/how-to-drop-user-on-netezza.html">How to drop a user on Netezza</a></p>
<pre><code class="lang-sql">CALL util..objects_owned_by(&#39;USER_NAME&#39;);</code></pre>
<ul>
<li><em>user_name</em> is not case sensitive</li>
<li>raise a notice if <em>user</em> does not exists</li>
</ul>
<h1 id="development">Development</h1>
<h2 id="generate-docs">Generate docs</h2>
<p>Documentation is generated extracting comments with a <code>--</code> in the beginning of line.</p>
<pre><code class="lang-sql">/* This kind of comments will be ignored */</code></pre>
<p>The following commands work also from Git shell on Windows.</p>
<h3 id="generate-readme-md">Generate README.md</h3>
<pre><code class="lang-bash">grep -E &#39;^--&#39; nz_util.sql | sed -e &#39;s/--//&#39; &gt; README.md</code></pre>
<h3 id="generate-html-docs">Generate html docs</h3>
<p>Install <a href="https://github.com/chjj/marked">marked</a> globally <strong>only once</strong>.</p>
<pre><code class="lang-bash">npm install marked -g</code></pre>
<p>Create docs/index.html from README.md</p>
<pre><code class="lang-bash">marked -o docs/index.html README.md</code></pre>
<p>Do a <code>git commit</code> then update site</p>
<pre><code class="lang-bash">git subtree --prefix docs push origin gh-pages</code></pre>
